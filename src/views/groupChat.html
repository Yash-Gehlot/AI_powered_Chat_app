<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Group Chat</title>
    <link rel="stylesheet" href="chat.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="http://localhost:4000/socket.io/socket.io.js"></script>
  </head>

  <body>
    <div class="user-container">
      <div class="search-box">
        <form id="search-form" onsubmit="handleSearch(event)">
          <input
            type="search"
            name="search"
            id="search-input"
            placeholder="Enter group name..."
          />
          <button id="create-room" type="submit">Join Group</button>
        </form>
      </div>
      <div class="users-box" id="users-box">
        <span class="chat-switcher" id="chat-switcher">Switch to Chats</span>
        <div id="online-users" style="margin-top: 10px"></div>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <h2 id="group-title">Group Chat</h2>
        <div>
          <span class="username-indicator">
            Signed as <span id="username-indicator"></span>
          </span>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages"></div>

      <div class="ai-replies" id="aiReplies" style="display: none">
        <strong>Quick Replies:</strong>
        <div id="aiRepliesButtons"></div>
      </div>

      <form class="chat-input" id="chatForm" onsubmit="handleSubmit(event)">
        <input
          type="text"
          id="messageInput"
          placeholder="Join a group first..."
          disabled
        />
        <button type="submit" id="sendBtn" disabled>Send</button>
      </form>
    </div>

    <script>
      const API_BASE = "http://localhost:4000";
      const messageLink = `${API_BASE}/chat`;

      const messageInput = document.getElementById("messageInput");
      const chatMessages = document.getElementById("chatMessages");
      const aiRepliesDiv = document.getElementById("aiReplies");
      const aiRepliesButtons = document.getElementById("aiRepliesButtons");
      const sendBtn = document.getElementById("sendBtn");
      const groupTitle = document.getElementById("group-title");

      const token = localStorage.getItem("token");
      const currentUser = localStorage.getItem("username");

      if (!token) {
        window.location.href = "login.html";
      }

      let currentGroupName = null;

      const socket = io(API_BASE, { auth: { token } });

      socket.on("connect", () => {
        console.log("‚úÖ Connected:", socket.id);
      });

      socket.on("connect_error", (err) => {
        console.error("Connection error:", err.message);
      });

      socket.on("group-messages", (data) => {
        console.log("üì© Group message received:", data);
        addMessage(data.message, "received", data.username);
        loadAIReplies();
      });

      socket.on("user-joined", (data) => {
        console.log(`üëã ${data.username} joined`);
        addSystemMessage(data.message);
      });

      socket.on("user-left", (data) => {
        console.log(`üëã ${data.username} left`);
        addSystemMessage(data.message);
      });

      socket.on("disconnect", () => {
        addSystemMessage("‚ö†Ô∏è Disconnected from server");
      });

      async function handleSubmit(event) {
        event.preventDefault();

        if (!currentGroupName) {
          alert("‚ö†Ô∏è Please join a group first!");
          return;
        }

        const message = messageInput.value.trim();
        if (!message) return;

        try {
          await axios.post(
            `${messageLink}/send`,
            { message },
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          socket.emit("group-messages", {
            message,
            groupName: currentGroupName,
          });

          addMessage(message, "sent");
          messageInput.value = "";

          setTimeout(loadAIReplies, 500);
        } catch (error) {
          console.error("‚ùå Send error:", error);
          alert("Failed to send message");
        }
      }

      async function loadAIReplies() {
        try {
          const response = await axios.get(`${messageLink}/receive`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const aiReplies = response.data.aiReplies || [];

          if (aiReplies.length > 0) {
            aiRepliesButtons.innerHTML = "";
            aiReplies.forEach((reply) => {
              const btn = document.createElement("button");
              btn.textContent = reply;
              btn.onclick = (e) => {
                e.preventDefault();
                messageInput.value = reply;
                messageInput.focus();
              };
              aiRepliesButtons.appendChild(btn);
            });
            aiRepliesDiv.style.display = "block";
          } else {
            aiRepliesDiv.style.display = "none";
          }
        } catch (error) {
          console.log("‚ö†Ô∏è AI replies unavailable:", error.response?.status);
          aiRepliesDiv.style.display = "none";
        }
      }

      function addMessage(text, type, username = "") {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", type);

        const label =
          type === "received" && username
            ? `<strong>${username}:</strong> `
            : "";
        messageDiv.innerHTML = `<p>${label}${text}</p>`;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addSystemMessage(text) {
        const div = document.createElement("div");
        div.style.cssText =
          "text-align: center; color: #6495ed; font-style: italic; padding: 8px; font-size: 12px; opacity: 0.8;";
        div.textContent = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      async function handleSearch(event) {
        event.preventDefault();

        const groupName = event.target.search.value.trim();
        if (!groupName) {
          alert("‚ö†Ô∏è Please enter a group name");
          return;
        }

        try {
          socket.emit("group-chat", { groupName });
          currentGroupName = groupName;

          chatMessages.innerHTML = "";
          addSystemMessage(`‚úÖ Joined group: ${groupName}`);

          messageInput.disabled = false;
          messageInput.placeholder = `Message to ${groupName}...`;
          sendBtn.disabled = false;
          groupTitle.textContent = `Group: ${groupName}`;

          console.log("‚úÖ Joined group:", groupName);
        } catch (error) {
          console.error("‚ùå Join group error:", error);
          alert("Error joining group");
        }

        event.target.reset();
      }

      const chatSwitcher = document.getElementById("chat-switcher");
      chatSwitcher.addEventListener("click", () => {
        window.location.href = "chat.html";
      });

      document.getElementById("username-indicator").textContent = currentUser;
    </script>
  </body>
</html>
