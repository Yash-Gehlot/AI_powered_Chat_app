<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Window</title>
    <link rel="stylesheet" href="chat.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  </head>
  <body>
    <div class="user-container">
      <div class="search-box">
        <form id="search-form" onsubmit="handleSearch(event)">
          <input
            type="search"
            name="search"
            id="search-input"
            placeholder="Search users by email..."
          />
          <button id="create-room" type="submit">Start Chat</button>
        </form>
      </div>
      <div class="users-box" id="users-box">
        <span class="chat-switcher" id="chat-switcher">Groups</span>
        <div id="users-list" style="margin-top: 10px"></div>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <h2 id="chat-title">Select a user to chat</h2>
        <div>
          <span class="username-indicator">
            Signed as <span id="username-indicator"></span>
          </span>
        </div>
      </div>
      <div class="chat-messages" id="chatMessages"></div>

      <form class="chat-input" id="chatForm">
        <input
          type="text"
          id="messageInput"
          placeholder="Select a user first..."
          disabled
        />
        <button type="submit" id="sendBtn" disabled>Send</button>
      </form>
    </div>

    <script>
      const API_BASE = "http://localhost:4000";
      const messageLink = `${API_BASE}/chat`;
      const userLink = `${API_BASE}/user`;

      const messageInput = document.getElementById("messageInput");
      const chatMessages = document.getElementById("chatMessages");
      const chatForm = document.getElementById("chatForm");
      const usersList = document.getElementById("users-list");
      const sendBtn = document.getElementById("sendBtn");
      const chatTitle = document.getElementById("chat-title");

      const token = localStorage.getItem("token");
      const currentUserEmail = localStorage.getItem("email");
      const currentUsername = localStorage.getItem("username");

      if (!token || !currentUserEmail) {
        window.location.href = "login.html";
      }

      let currentRoom = null;
      let currentChatUser = null;
      let unreadCounts = {};

      const socket = io(API_BASE, {
        auth: { token },
      });

      socket.on("connect", () => {
        console.log("‚úÖ Connected:", socket.id);
        loadUnreadCounts();
      });

      socket.on("connect_error", (err) => {
        console.error("‚ùå Connection error:", err.message);
      });

      // Receive new messages
      socket.on("new-message", (data) => {
        console.log("üì© Received message:", data);
        addMessage(data.message, "received", data.username);
      });

      // Receive notifications for messages when not in chat
      socket.on("new-notification", (data) => {
        console.log("üîî New notification:", data);

        // Update unread count for this room
        const room = data.roomName;
        unreadCounts[room] = (unreadCounts[room] || 0) + 1;
        updateNotificationBadges();

        // Show browser notification if permitted
        if (Notification.permission === "granted") {
          new Notification(`New message from ${data.fromUsername}`, {
            body: data.message,
            icon: "/favicon.ico",
          });
        }
      });

      // Load unread counts from server
      async function loadUnreadCounts() {
        try {
          const response = await axios.get(`${messageLink}/unread-counts`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          unreadCounts = response.data.unreadCounts || {};
          updateNotificationBadges();
        } catch (error) {
          console.error("Failed to load unread counts:", error);
        }
      }

      // Update notification badges on user cards
      function updateNotificationBadges() {
        document.querySelectorAll(".users-cards").forEach((card) => {
          const email = card.dataset.email;
          const roomName = [currentUserEmail, email].sort().join("-");
          const count = unreadCounts[roomName] || 0;

          // Remove existing badge
          const existingBadge = card.querySelector(".notification-badge");
          if (existingBadge) {
            existingBadge.remove();
          }

          // Add new badge if count > 0
          if (count > 0) {
            const badge = document.createElement("span");
            badge.className = "notification-badge";
            badge.textContent = count;
            card.appendChild(badge);
          }
        });
      }

      // Send message
      chatForm.addEventListener("submit", handleSubmit);

      async function handleSubmit(event) {
        event.preventDefault();

        if (!currentRoom) {
          alert("‚ö†Ô∏è Please select a user to chat with!");
          return;
        }

        const message = messageInput.value.trim();
        if (!message) return;

        try {
          // Save message in DB with roomName
          await axios.post(
            `${messageLink}/send`,
            { message, roomName: currentRoom },
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          // Emit to the specific room
          socket.emit("new-message", {
            message,
            roomName: currentRoom,
          });

          // Show in UI
          addMessage(message, "sent");
          messageInput.value = "";
        } catch (error) {
          console.error("‚ùå Send error:", error);
          alert("Failed to send message");
        }
      }

      // Join room and start chat
      async function handleSearch(event) {
        event.preventDefault();
        const targetEmail = event.target.search.value.trim();

        if (!targetEmail) {
          alert("‚ö†Ô∏è Please enter an email");
          return;
        }

        if (targetEmail === currentUserEmail) {
          alert("‚ö†Ô∏è You cannot chat with yourself!");
          return;
        }

        try {
          const response = await axios.post(
            `${userLink}/all`,
            { email: targetEmail },
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          const targetUser = response.data.verifiedEmail;

          // Create consistent room name
          const roomName = [currentUserEmail, targetEmail].sort().join("-");
          currentRoom = roomName;
          currentChatUser = targetUser.username;

          // Join the room via socket
          socket.emit("join-room", { roomName });

          // Mark messages as read
          await axios.post(
            `${messageLink}/mark-read`,
            { roomName },
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          // Clear unread count for this room
          unreadCounts[roomName] = 0;
          updateNotificationBadges();

          // Update UI
          chatMessages.innerHTML = "";
          addSystemMessage(`‚úÖ Started chat with ${targetUser.username}`);

          chatTitle.textContent = `Chat with ${targetUser.username}`;
          messageInput.disabled = false;
          messageInput.placeholder = `Message ${targetUser.username}...`;
          sendBtn.disabled = false;

          console.log("‚úÖ Joined room:", roomName);

          // Load previous messages for this room
          await loadRoomMessages(roomName);
        } catch (error) {
          console.error("‚ùå Error:", error);
          alert(error.response?.data?.message || "User not found");
        }

        event.target.reset();
      }

      // Load messages for specific room
      async function loadRoomMessages(roomName) {
        try {
          const response = await axios.get(
            `${messageLink}/receive?roomName=${roomName}`,
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          const messages = response.data.messages || [];

          messages.forEach((msg) => {
            const isFromMe = msg.User.email === currentUserEmail;
            addMessage(
              msg.message,
              isFromMe ? "sent" : "received",
              isFromMe ? "" : msg.User.username
            );
          });
        } catch (error) {
          console.error("‚ùå Load messages error:", error);
        }
      }

      // Add message to UI
      function addMessage(text, type, username = "") {
        const div = document.createElement("div");
        div.classList.add("message", type);

        const label =
          type === "received" && username
            ? `<strong>${username}:</strong> `
            : "";
        div.innerHTML = `<p>${label}${text}</p>`;

        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function addSystemMessage(text) {
        const div = document.createElement("div");
        div.style.cssText =
          "text-align: center; color: #6495ed; font-style: italic; padding: 8px; font-size: 12px; opacity: 0.8;";
        div.textContent = text;
        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Load all users on page load
      window.addEventListener("DOMContentLoaded", async () => {
        // Request notification permission
        if (Notification.permission === "default") {
          Notification.requestPermission();
        }

        try {
          const response = await axios.get(`${userLink}/users`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const users = response.data.users;
          users.forEach((user) => {
            if (user.email === currentUserEmail) return;

            const userCard = document.createElement("div");
            userCard.classList.add("users-cards");
            userCard.dataset.email = user.email;
            userCard.style.cursor = "pointer";
            userCard.innerHTML = `
              <p><strong>${user.username}</strong></p>
              <p style="font-size: 12px; color: #666;">${user.email}</p>
            `;

            userCard.onclick = () => {
              document.getElementById("search-input").value = user.email;
              document
                .getElementById("search-form")
                .dispatchEvent(new Event("submit"));
            };

            usersList.appendChild(userCard);
          });

          // Load unread counts after rendering users
          loadUnreadCounts();
        } catch (error) {
          console.error("‚ùå Load users error:", error);
        }
      });

      // Chat switcher
      const chatSwitcher = document.getElementById("chat-switcher");
      chatSwitcher.addEventListener("click", () => {
        window.location.href = "groupChat.html";
      });

      // Set current user
      document.getElementById("username-indicator").textContent =
        currentUsername;
    </script>
  </body>
</html>
