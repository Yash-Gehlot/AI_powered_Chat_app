<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Window</title>
    <link rel="stylesheet" href="chat.css" />
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  </head>
  <body>
    <div class="user-container">
      <div class="search-box">
        <form id="search-form" onsubmit="handleSearch(event)">
          <input
            type="search"
            name="search"
            id="search-input"
            placeholder="Search users..."
          />
          <button id="create-room" type="submit">Create Room</button>
        </form>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-header"><h2>Chat Room</h2></div>
      <div class="chat-messages" id="chatMessages"></div>

      <form class="chat-input" id="chatForm">
        <input
          type="text"
          id="messageInput"
          placeholder="Type a message..."
          required
        />
        <button type="submit">Send</button>
      </form>
    </div>

    <script>
      const messageLink = "http://localhost:4000/chat";
      const emailVerificationLink = `http://localhost:4000/user`;
      const messageInput = document.getElementById("messageInput");
      const chatMessages = document.getElementById("chatMessages");
      const chatForm = document.getElementById("chatForm");

      const token = localStorage.getItem("token");
      if (!token) {
        window.location.href = "signup.html";
      }

      // Socket connection (same as reference)
      const socket = io("ws://localhost:4000", {
        auth: { token },
      });

      socket.on("connect", () => {
        console.log("Connected:", socket.id);
      });

      // ✅ Receive real-time message
      socket.on("new-message", (data) => {
        addMessage(data.message, "received");
      });

      // ✅ Send message
      chatForm.addEventListener("submit", handleSubmit);

      async function handleSubmit(event) {
        event.preventDefault();

        const message = messageInput.value.trim();
        if (!message) return;

        try {
          // 1️⃣ Save message in DB
          await axios.post(
            `${messageLink}/send`,
            { message },
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          // 2️⃣ Emit via socket (ROOM BASED)
          socket.emit("new-message", {
            message,
            roomName: window.roomName,
          });

          // 3️⃣ Show in UI
          addMessage(message, "sent");
        } catch (error) {
          console.log(error.response);
        }

        event.target.reset();
      }

      // ✅ Load old messages on page load
      window.addEventListener("DOMContentLoaded", async () => {
        try {
          const response = await axios.get(`${messageLink}/receive`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const messages = response.data.messages || [];
          const messageType = response.data.message;

          messages.forEach((msg) => {
            addMessage(msg.message, messageType);
          });
        } catch (error) {
          console.log(error.response);
        }
      });

      // ✅ Add message to UI
      function addMessage(text, type) {
        const div = document.createElement("div");
        div.classList.add("message", type);

        div.innerHTML = `<p>${text}</p>`;

        chatMessages.appendChild(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // ✅ Join room (same as reference)
      async function handleSearch(event) {
        event.preventDefault();
        const myEmail = localStorage.getItem("email");
        const meetingEmail = event.target.search.value.trim();

        const roomName = [myEmail, meetingEmail].sort().join("-");

        try {
          const response = await axios.post(
            `${emailVerificationLink}/all`,
            { email: meetingEmail },
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );
          window.roomName = roomName;
          socket.emit("join-room", { roomName });
          alert("Room we join: " + roomName);
          console.log(response?.data?.verifiedEmail?.email);
        } catch (error) {
          alert("Error facing joinig Room: " + error.message);
          console.log(error.message);
        }

        event.target.reset();
      }
    </script>
  </body>
</html>
